version: 2.1
jobs:
  build-builder:
    machine:
      image: ubuntu-2004:202107-02
      resource_class: large
      docker_layer_caching: true
    steps:
      - checkout
      - run:
          name: Build
          command: docker build -f ./ops/docker/Dockerfile.builder -t mslipper/optimism-builder:$CIRCLE_SHA1 .
      - run:
          name: Push
          command: |
            echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker push mslipper/optimism-builder:$CIRCLE_SHA1


  build-itests:
    machine:
      image: ubuntu-2004:202107-02
      resource_class: large
      docker_layer_caching: true
    steps:
      - checkout
      - run: |
          docker build -f ./ops/docker/Dockerfile.integration-tests \
            -t mslipper/optimism-integration-tests:$CIRCLE_SHA1 \
            --build-arg TAG=$CIRCLE_SHA1 \
            .

workflows:
  build-monorepo:
    jobs:
      - build-builder:
          context: optimism
      - build-itests:
          context: optimism
          requires:
            - build-builder
